<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<dom-module id="app-globals" attributes="namespace">
  <script>
    (function() {
      var _globals = {};
      var _observers = {};
      var _instances = [];
      
      var _fire = function(name, detail) {
        _instances.forEach(function(instance) {
          if (instance.namespace === detail.namespace) {
            instance.fire(name, detail);
          }
        });
      }
                               
      var _observeFn = function(namespace, added, removed, changed, getOldValueFn) {
        if (namespace === '__default'){ namespace = null; }
        Object.keys(added).forEach(function(prop) {
          var detail =  {
            event: 'add',
            namespace: namespace, 
            property: prop, 
            value: added[prop], 
            oldValue: getOldValueFn(prop)
          }
          _fire('app-globals-update', detail);
          _fire('app-globals-add', detail);
        });
          
        Object.keys(removed).forEach(function(prop) {
          var detail =  {
            event: 'remove',
            namespace: namespace, 
            property: prop, 
            value: undefined,
            oldValue: getOldValueFn(prop)
          }
          _fire('app-globals-update', detail);
          _fire('app-globals-remove', detail);
        });
          
        Object.keys(changed).forEach(function(prop) {
          var detail =  {
            event: 'change',
            namespace: namespace, 
            property: prop, 
            value: changed[prop], 
            oldValue: getOldValueFn(prop)
          }
          _fire('app-globals-update', detail);
          _fire('app-globals-change', detail);
        });
      }
      
      var _makeAndObserve = function(namespace) {
        _globals[namespace] || (_globals[namespace] = {});
        _observers[namespace] = new ObjectObserver(_globals[namespace]);
        _observers[namespace].open(function(a,r,c,o) {
          _observeFn(namespace,a,r,c,o);
        });
        return _globals[namespace];
      };
      
      Polymer({
        is: 'app-globals',
        publish: {
          values: undefined
        },
        observe: {
          namespace: 'resetData'
        },
        
        /**
         * The (optional) `namespace` attribute lets you have multiple
         * scopes of globals.
         * 
         * @attribute namespace
         * @type string
         */
        namespace: undefined,
        /**
         * The `values` attribute is an object containing the set globals for
         * the current namespace. You can bind to this.
         * 
         * @attribute values
         * @type object
         */
        created: function() {
          _instances.push(this);
          this.resetData();
        },
        get _ns() {
          return this.namespace || '__default';
        },
        
        get values() {
          this.resetData();
          return _globals[this._ns];
        },
        
        set values(data) {
          throw "[app-globals] ERROR: Globals objects are immutable. You can only work on subkeys.";
        },
        
        resetData: function() {
          if (!_globals[this._ns]) {
            _makeAndObserve(this._ns);
          }
        }
        /**
         * The `app-globals-change` event is fired on each element whenever a
         * global variable is added. The detail is an object including the 
         * `namespace`, `property`, `value`, and `oldValue`.
         * 
         * @event app-globals-add
         */
         
        /**
         * The `app-globals-change` event is fired on each element whenever a
         * global variable is removed. The detail is an object including the 
         * `namespace`, `property`, `value`, and `oldValue`.
         * 
         * @event app-globals-remove
         */
        
        /**
         * The `app-globals-change` event is fired on each element whenever a
         * global variable is modified. The detail is an object including the 
         * `namespace`, `property`, `value`, `oldValue`.
         * 
         * @event app-globals-change
         */
        
        /**
         * The `app-globals-update` event is fired on each element whenever any
         * kind of alteration (add, remove, change) is made. The detail is an
         * object including the `namespace`, `property`, `value`, `oldValue`.
         * 
         * @event app-globals-update
         */
      });
    })();
  </script>
</dom-module>